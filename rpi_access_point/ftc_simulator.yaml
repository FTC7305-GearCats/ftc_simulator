---
# Set up the actual simulator app.

- hosts: edison
  remote_user: dwatson
  become: yes

  tasks:
    - name: Create directories.
      file:
        path: /home/dwatson/{{ item.dir }}
        owner: dwatson
        group: dwatson
        state: directory
        mode: '0755'
      with_items:
        - { dir: 'work' }
        - { dir: 'work/ftc_simulator' }
        - { dir: 'work/ftc_simulator/src' }

    - name: Copy requirements file.
      copy:
        src: /Users/dwatson/work/ftc_simulator/src/requirements.txt
        dest: /home/dwatson/work/ftc_simulator/src/requirements.txt
        owner: dwatson
        group: dwatson
        mode: 0644

    - name: Create venv for insteon programs.
      pip:
        requirements: /home/dwatson/work/ftc_simulator/src/requirements.txt
        virtualenv: /home/dwatson/work/ftc_simulator/src/venv
        virtualenv_command: /usr/bin/python3 -m venv

    - name: Copy src files.
      copy:
        src: /Users/dwatson/work/ftc_simulator/src/{{ item.src }}
        dest: /home/dwatson/work/ftc_simulator/src/
        owner: dwatson
        group: dwatson
        mode: 0644
      with_items:
        - { src: 'server.py' }
        - { src: 'fetch_from_phone.py' }
        - { src: 'setup.sql' }

    - name: Copy ftc sim uwsgi config.
      copy:
        src: ftc_sim_uwsgi.ini
        dest: /etc/uwsgi/apps-available/
        owner: root
        group: root
        mode: 0644
      notify:
        - restart uwsgi

    - name: Enable ftc sim uwsgi config.
      file:
        src: /etc/uwsgi/apps-available/ftc_sim_uwsgi.ini
        dest: /etc/uwsgi/apps-enabled/ftc_sim_uwsgi.ini
        state: link
      notify:
        - restart uwsgi

  handlers:
    - name: restart uwsgi
      service:
        name: uwsgi
        enabled: yes
        state: restarted
